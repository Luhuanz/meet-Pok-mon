import ollama
import json
import re
def Intent_Recognition(query, choice='qwen2.5:7b'):
    prompt = f"""
    阅读以下提示，判断用户问题中的意图（问题在最后的 {{query}}），从下列『意图类别』中进行匹配：
    1. 查询宝可梦属性
    2. 查询宝可梦进化关系
    3. 查询宝可梦所在地
    4. 查询宝可梦能力特性
    5. 查询人物拥有的宝可梦
    6. 查询人物的出生地或地区
    7. 查询人物关系（如亲戚、伙伴、敌对）
    8. 查询地区拥有的宝可梦
    9. 查询人物属性（如姓名、性别、中英文名）


    **识别意图的方法：**
    - 请仔细阅读用户的问题，分析其真正的需求。
    - 对照上面『意图类别』的含义，看看用户是否在询问“属性”、“进化关系”、“所在地”等。
    - 如果用户的问题里显式或隐式地包含某个意图，就把对应的意图类别放入输出列表中。
    - 最终输出列表中，只能包含以上列出的意图类别，**不可以**创造新类别。
    - 如果可能存在多个意图（比如既问“拥有哪些宝可梦”，又问“它们有什么特性”），可以全部列入；但不超过 5 个。
    - 确保最终的输出列表包含了所有与用户问题相关的类别描述。

    以下是一些含有隐晦性意图的例子，每个例子都采用了输入和输出格式，并包含了对你进行思维链形成的提示：

    **示例1：**
    输入："赤红拥有哪些宝可梦？他们的特性是什么？"
    输出：["查询人物拥有的宝可梦", "查询宝可梦能力特性"] 

    **示例2：**
    输入："妙蛙种子会进化成什么？在哪个地区能找到它？"
    输出：["查询宝可梦进化关系", "查询宝可梦所在地"] 

    **示例3：**
    输入："皮卡丘有哪些属性和特性？"
    输出：["查询宝可梦属性", "查询宝可梦能力特性"] 

    **示例4：**
    输入："赤红和小智之间是什么关系？赤红的性别是什么？"
    输出：["查询人物关系", "查询人物属性"]

    **示例5：**
    输入："真新镇有哪些著名宝可梦？"
    输出：["查询地区拥有的宝可梦"] 
   **示例6：**
    输入："皮卡丘的进化是什么？"
    输出：["查询宝可梦进化关系"] 
    **注意：**
    1. 只能输出在上述意图类别范围内的内容，请不要新建其他名称。
    2. 最多输出 5 个类别，如果用户的问题涉及过多意图，请只选最核心的 5 个。
    下面是你要处理的真实问题，请进行意图识别并输出结果！

    用户问题："{query}"

    请在输出时：
    - 返回一个 Python 列表，元素是字符串形式的意图类别，如 ["查询宝可梦所在地","查询宝可梦属性"]。
    """

    rec_result = ollama.generate(model=choice, prompt=prompt)['response']
    match = re.search(r"\[.*?\]", rec_result, re.DOTALL)
    if match:
        list_str = match.group(0)  # 提取到方括号内的内容
        try:
            parsed_result = json.loads(list_str)  # 解析 JSON
            if isinstance(parsed_result, list):
                return parsed_result
        except json.JSONDecodeError:
            print(f"JSON解析失败，提取后的内容: {list_str}")
    else:
        print(f"未找到匹配的列表，原始输出: {rec_result}")

    return rec_result
if __name__ == '__main__':
    temp=Intent_Recognition('皮卡丘进化是什么')
    print(temp)